{% extends 'chat/base.html' %}

{% block title %}Room Details{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f5f5f5;
        min-height: 100vh;
    }
    .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .card-header {
        background-color: white;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        border-radius: 15px 15px 0 0 !important;
        padding: 1.5rem;
    }
    .stat-pill {
        padding: 0.5rem 0.75rem;
        border-radius: 1rem;
        background: rgba(102, 126, 234, 0.1);
        color: #4a4a4a;
    }
</style>
{% endblock %}

{% block body %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
	<div class="container-fluid">
		<a class="navbar-brand" href="/rooms/">
			<i class="bi bi-arrow-left"></i> Back to Rooms
		</a>
		<div class="d-flex align-items-center gap-2">
			<button class="btn btn-outline-light btn-sm" onclick="window.location.href='/profile/'" title="Profile">
				<i class="bi bi-person-circle"></i>
			</button>
			<button class="btn btn-outline-light btn-sm" onclick="logout()">
				<i class="bi bi-box-arrow-right"></i>
			</button>
		</div>
	</div>
</nav>

<div class="container py-4">
	<div id="alertContainer"></div>
	<div class="row g-4">
		<div class="col-lg-5">
			<div class="card shadow-sm h-100">
				<div class="card-header bg-white">
					<h5 class="mb-0">Room Overview</h5>
				</div>
				<div class="card-body d-flex flex-column">
					<div class="mb-4">
						<small class="text-muted">Room Name</small>
						<h3 class="mb-1" id="roomName">Loading...</h3>
						<div class="stat-pill d-inline-flex align-items-center gap-2">
							<i class="bi bi-hash"></i>
							<span id="roomType">-</span>
						</div>
					</div>
					<ul class="list-group list-group-flush small">
						<li class="list-group-item px-0 d-flex justify-content-between">
							<span>Room ID</span>
							<span class="text-muted" id="roomIdDisplay">#{{ room_id }}</span>
						</li>
						<li class="list-group-item px-0 d-flex justify-content-between">
							<span>Created On</span>
							<span class="text-muted" id="roomCreatedAt">--</span>
						</li>
						<li class="list-group-item px-0 d-flex justify-content-between">
							<span>Total Participants</span>
							<span class="text-muted" id="participantCount">0</span>
						</li>
					</ul>
					<div class="mt-auto pt-4 d-grid gap-2">
						<a class="btn btn-primary" id="openChatBtn" href="/chat/{{ room_id }}/">
							<i class="bi bi-chat-dots"></i> Open Chat
						</a>
						<button class="btn btn-outline-secondary" onclick="window.location.href='/rooms/'">
							<i class="bi bi-arrow-left"></i> Back to Rooms
						</button>
						<button class="btn btn-outline-danger" onclick="deleteRoom()">
							<span class="spinner-border spinner-border-sm d-none" id="deleteSpinner"></span>
							Delete Room
						</button>
					</div>
				</div>
			</div>
		</div>
		<div class="col-lg-7">
			<div class="card shadow-sm h-100">
				<div class="card-header bg-white d-flex justify-content-between align-items-center">
					<h5 class="mb-0">Participants</h5>
					<span class="badge bg-primary" id="participantBadge">0</span>
				</div>
				<div class="card-body">
					<ul class="list-group mb-4" id="participantsList">
						<li class="list-group-item text-center text-muted">Loading participants...</li>
					</ul>
					<div id="addParticipantSection" class="d-none">
						<h6>Add Participant</h6>
						<form id="addParticipantForm" class="row g-2 align-items-center">
							<div class="col-sm-8">
								<input type="email" class="form-control" id="participantEmail" placeholder="user@example.com" required>
							</div>
							<div class="col-sm-4 d-grid">
								<button type="submit" class="btn btn-primary">
									<span class="spinner-border spinner-border-sm d-none" id="participantSpinner"></span>
									Add
								</button>
							</div>
						</form>
						<small class="text-muted d-block mt-2">Only group rooms support adding new participants.</small>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
	const ROOM_ID = {{ room_id }};
	const API_URL = window.location.origin;
	let currentRoom = null;

	function getAuthHeaders() {
		const token = localStorage.getItem('access_token');
		return {
			'Content-Type': 'application/json',
			'Authorization': `Bearer ${token}`
		};
	}

	function showAlert(message, type = 'danger') {
		const alertContainer = document.getElementById('alertContainer');
		alertContainer.innerHTML = `
			<div class="alert alert-${type} alert-dismissible fade show" role="alert">
				${message}
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>
		`;
	}

	function formatDate(dateString) {
		return new Date(dateString).toLocaleString();
	}

	function renderParticipants(participants) {
		const list = document.getElementById('participantsList');
		if (!participants.length) {
			list.innerHTML = '<li class="list-group-item text-center text-muted">No participants yet.</li>';
			return;
		}

		list.innerHTML = participants.map((participant, index) => `
			<li class="list-group-item d-flex justify-content-between align-items-center">
				<div>
					<strong>${participant.first_name || participant.last_name ? `${participant.first_name || ''} ${participant.last_name || ''}`.trim() : participant.email}</strong>
					<div class="text-muted small">${participant.email}</div>
				</div>
				<span class="badge bg-light text-dark">#${index + 1}</span>
			</li>
		`).join('');
	}

	async function loadRoom() {
		try {
			const response = await fetch(`${API_URL}/api/chat/rooms/${ROOM_ID}/`, {
				headers: getAuthHeaders()
			});

			if (!response.ok) {
				throw new Error('Unable to load room');
			}

			const room = await response.json();
			currentRoom = room;

			document.getElementById('roomName').textContent = room.name || 'Direct Message';
			document.getElementById('roomType').textContent = room.room_type;
			document.getElementById('roomCreatedAt').textContent = formatDate(room.created_at);
			document.getElementById('participantCount').textContent = room.participant_count;
			document.getElementById('participantBadge').textContent = room.participant_count;
			document.getElementById('openChatBtn').href = `/chat/${ROOM_ID}/`;

			renderParticipants(room.participants);

			const addSection = document.getElementById('addParticipantSection');
			if (room.room_type === 'group') {
				addSection.classList.remove('d-none');
			} else {
				addSection.classList.add('d-none');
			}
		} catch (error) {
			console.error('Error loading room:', error);
			showAlert('Failed to load room details.', 'danger');
		}
	}

	async function addParticipant(event) {
		event.preventDefault();
		const emailInput = document.getElementById('participantEmail');
		const spinner = document.getElementById('participantSpinner');

		spinner.classList.remove('d-none');

		try {
			const response = await fetch(`${API_URL}/api/chat/rooms/${ROOM_ID}/add_participant/`, {
				method: 'POST',
				headers: getAuthHeaders(),
				body: JSON.stringify({ email: emailInput.value })
			});

			const data = await response.json().catch(() => ({}));

			if (response.ok) {
				showAlert('Participant added successfully.', 'success');
				emailInput.value = '';
				loadRoom();
			} else {
				showAlert(data.detail || data.error || 'Unable to add participant.', 'danger');
			}
		} catch (error) {
			console.error('Error adding participant:', error);
			showAlert('Failed to add participant.', 'danger');
		} finally {
			spinner.classList.add('d-none');
		}
	}

	async function deleteRoom() {
		if (!confirm('Are you sure you want to delete this room? This action cannot be undone.')) {
			return;
		}

		const spinner = document.getElementById('deleteSpinner');
		spinner.classList.remove('d-none');

		try {
			const response = await fetch(`${API_URL}/api/chat/rooms/${ROOM_ID}/`, {
				method: 'DELETE',
				headers: getAuthHeaders()
			});

			if (response.ok) {
				showAlert('Room deleted.', 'success');
				setTimeout(() => window.location.href = '/rooms/', 1000);
			} else {
				const data = await response.json().catch(() => ({}));
				showAlert(data.detail || 'Unable to delete room.', 'danger');
			}
		} catch (error) {
			console.error('Error deleting room:', error);
			showAlert('Failed to delete room.', 'danger');
		} finally {
			spinner.classList.add('d-none');
		}
	}

	function logout() {
		localStorage.removeItem('access_token');
		localStorage.removeItem('refresh_token');
		window.location.href = '/login/';
	}

	if (!localStorage.getItem('access_token')) {
		window.location.href = '/login/';
	} else {
		loadRoom();
	}

	document.getElementById('addParticipantForm').addEventListener('submit', addParticipant);
</script>
{% endblock %}
