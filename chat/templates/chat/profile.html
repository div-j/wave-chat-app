{% extends 'chat/base.html' %}

{% block title %}My Profile{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f5f5f5;
        min-height: 100vh;
    }
    .profile-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .card-header {
        background-color: white;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        border-radius: 15px 15px 0 0 !important;
        padding: 1.5rem;
    }
</style>
{% endblock %}

{% block body %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
	<div class="container-fluid">
		<a class="navbar-brand" href="/rooms/">
			<i class="bi bi-arrow-left"></i> Back to Rooms
		</a>
		<div class="d-flex align-items-center gap-2">
			<button class="btn btn-outline-light btn-sm" onclick="logout()">
				<i class="bi bi-box-arrow-right"></i> Logout
			</button>
		</div>
	</div>
</nav>

<div class="container py-5">
	<div class="row justify-content-center">
		<div class="col-lg-6">
			<div class="card profile-card">
				<div class="card-header bg-white d-flex justify-content-between align-items-center">
					<div>
						<h4 class="mb-0">My Profile</h4>
						<small class="text-muted" id="profileStatus">Loading profile...</small>
					</div>
					<span class="badge bg-primary" id="profileEmailBadge">--</span>
				</div>
				<div class="card-body">
					<div id="alertContainer"></div>
					<form id="profileForm" class="row g-3">
						<div class="col-md-6">
							<label for="firstName" class="form-label">First Name</label>
							<input type="text" class="form-control" id="firstName" required>
						</div>
						<div class="col-md-6">
							<label for="lastName" class="form-label">Last Name</label>
							<input type="text" class="form-control" id="lastName" required>
						</div>
						<div class="col-12">
							<label for="email" class="form-label">Email</label>
							<input type="email" class="form-control" id="email" disabled>
						</div>
						<div class="col-12 text-end">
							<button type="button" class="btn btn-outline-secondary me-2" onclick="window.location.href='/rooms/'">
								Cancel
							</button>
							<button type="submit" class="btn btn-primary">
								<span class="spinner-border spinner-border-sm d-none" id="profileSpinner"></span>
								Save Changes
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
	const API_URL = window.location.origin;

	function getAuthHeaders() {
		const token = localStorage.getItem('access_token');
		return {
			'Content-Type': 'application/json',
			'Authorization': `Bearer ${token}`
		};
	}

	function showAlert(message, type = 'danger') {
		const alertContainer = document.getElementById('alertContainer');
		alertContainer.innerHTML = `
			<div class="alert alert-${type} alert-dismissible fade show" role="alert">
				${message}
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>
		`;
	}

	async function loadProfile() {
		try {
			const response = await fetch(`${API_URL}/api/account/profile/`, {
				headers: getAuthHeaders()
			});

			if (!response.ok) {
				throw new Error('Unable to load profile');
			}

			const data = await response.json();
			document.getElementById('firstName').value = data.first_name || '';
			document.getElementById('lastName').value = data.last_name || '';
			document.getElementById('email').value = data.email || '';
			document.getElementById('profileEmailBadge').textContent = data.email || '--';
			document.getElementById('profileStatus').textContent = 'Profile ready';
		} catch (error) {
			console.error('Error loading profile:', error);
			showAlert('Failed to load profile. Please login again.');
			document.getElementById('profileStatus').textContent = 'Unable to load profile.';
		}
	}

	async function updateProfile(event) {
		event.preventDefault();
		const spinner = document.getElementById('profileSpinner');
		spinner.classList.remove('d-none');

		const payload = {
			first_name: document.getElementById('firstName').value,
			last_name: document.getElementById('lastName').value
		};

		try {
			const response = await fetch(`${API_URL}/api/account/profile/`, {
				method: 'PUT',
				headers: getAuthHeaders(),
				body: JSON.stringify(payload)
			});

			if (response.ok) {
				showAlert('Profile updated successfully.', 'success');
			} else {
				const data = await response.json().catch(() => ({}));
				showAlert(data.detail || 'Failed to update profile.');
			}
		} catch (error) {
			console.error('Error updating profile:', error);
			showAlert('An unexpected error occurred.');
		} finally {
			spinner.classList.add('d-none');
		}
	}

	function logout() {
		localStorage.removeItem('access_token');
		localStorage.removeItem('refresh_token');
		window.location.href = '/login/';
	}

	if (!localStorage.getItem('access_token')) {
		window.location.href = '/login/';
	} else {
		loadProfile();
	}

	document.getElementById('profileForm').addEventListener('submit', updateProfile);
</script>
{% endblock %}
