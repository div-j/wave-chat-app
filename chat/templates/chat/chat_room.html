{% extends 'chat/base.html' %}

{% block title %}Chat Room{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f5f5f5;
        height: 100vh;
        overflow: hidden;
    }
    .chat-container {
        height: calc(100vh - 56px);
        display: flex;
        flex-direction: column;
    }
    .chat-header {
        background: white;
        border-bottom: 1px solid #dee2e6;
        padding: 1rem;
    }
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #e5ddd5;
    }
    .message {
        margin-bottom: 1rem;
        display: flex;
    }
    .message.sent {
        justify-content: flex-end;
    }
    .message.received {
        justify-content: flex-start;
    }
    .message-bubble {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        position: relative;
    }
    .message.sent .message-bubble {
        background: #667eea;
        color: white;
        border-bottom-right-radius: 0.25rem;
    }
    .message.received .message-bubble {
        background: white;
        border-bottom-left-radius: 0.25rem;
    }
    .message-meta {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }
    .message-input-container {
        background: white;
        border-top: 1px solid #dee2e6;
        padding: 1rem;
    }
    .typing-indicator {
        font-size: 0.85rem;
        color: #6c757d;
        font-style: italic;
        padding: 0.5rem 1rem;
    }
    #connectionStatus {
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block body %}
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/rooms/">
                <i class="bi bi-arrow-left"></i> Back to Rooms
            </a>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-light btn-sm" onclick="window.location.href='/profile/'" title="Profile">
                    <i class="bi bi-person-circle"></i>
                </button>
                <span id="connectionStatus" class="text-light me-2">
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    Connecting...
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0" id="roomName">Loading...</h5>
                    <small class="text-muted" id="roomInfo"></small>
                </div>
                <a class="btn btn-sm btn-outline-secondary" href="/rooms/{{ room_id }}/details/">
                    <i class="bi bi-info-circle"></i> Room Details
                </a>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="messages-container" id="messagesContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading messages...</span>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="typing-indicator d-none"></div>

        <!-- Message Input -->
        <div class="message-input-container">
            <div class="input-group">
                <input type="text" class="form-control" id="messageInput" 
                       placeholder="Type a message..." disabled>
                <button class="btn btn-primary" type="button" id="sendBtn" disabled>
                    <i class="bi bi-send-fill"></i> Send
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        const ROOM_ID = "{{ room_id }}";
        const API_URL = window.location.origin;
        const WS_URL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        let chatSocket = null;
        let currentUser = null;
        let typingTimeout = null;

        function getAuthHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        async function loadRoomDetails() {
            try {
                const response = await fetch(`${API_URL}/api/chat/rooms/${ROOM_ID}/`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const room = await response.json();
                    document.getElementById('roomName').textContent = room.name || 'Direct Message';
                    document.getElementById('roomInfo').textContent = 
                        `${room.room_type} â€¢ ${room.participant_count} participant(s)`;
                }
            } catch (error) {
                console.error('Error loading room details:', error);
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch(`${API_URL}/api/chat/messages/?room=${ROOM_ID}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const messages = await response.json();
                    const messagesContainer = document.getElementById('messagesContainer');
                    
                    if (messages.length === 0) {
                        messagesContainer.innerHTML = `
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-text" style="font-size: 3rem;"></i>
                                <p class="mt-3">No messages yet. Start the conversation!</p>
                            </div>
                        `;
                    } else {
                        messagesContainer.innerHTML = messages.reverse().map(msg => 
                            createMessageHTML(msg)
                        ).join('');
                        scrollToBottom();
                    }
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        async function loadCurrentUser() {
            try {
                const response = await fetch(`${API_URL}/api/account/profile/`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Error loading user:', error);
                logout();
            }
        }

        function connectWebSocket() {
            const token = localStorage.getItem('access_token');
            chatSocket = new WebSocket(
                `${WS_URL}//${window.location.host}/ws/chat/${ROOM_ID}/?token=${token}`
            );

            chatSocket.onopen = function(e) {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            };

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('WebSocket message:', data);

                if (data.type === 'chat_message') {
                    addMessageToUI(data.message);
                } else if (data.type === 'typing_indicator') {
                    showTypingIndicator(data.email);
                } else if (data.type === 'error') {
                    console.error('WebSocket error:', data.message);
                }
            };

            chatSocket.onclose = function(e) {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;

                // Attempt to reconnect after 3 seconds
                setTimeout(() => {
                    console.log('Attempting to reconnect...');
                    connectWebSocket();
                }, 3000);
            };

            chatSocket.onerror = function(e) {
                console.error('WebSocket error:', e);
            };
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'type': 'chat_message',
                    'message': message
                }));
                messageInput.value = '';
            }
        }

        function sendTypingIndicator() {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'type': 'typing'
                }));
            }
        }

        function createMessageHTML(message) {
            const isSent = currentUser && message.sender.id === currentUser.id;
            const messageClass = isSent ? 'sent' : 'received';
            const senderName = `${message.sender.first_name} ${message.sender.last_name}`.trim() || message.sender.email;
            const time = new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            return `
                <div class="message ${messageClass}">
                    <div class="message-bubble">
                        ${!isSent ? `<div><strong>${senderName}</strong></div>` : ''}
                        <div>${escapeHtml(message.content)}</div>
                        <div class="message-meta">${time}</div>
                    </div>
                </div>
            `;
        }

        function addMessageToUI(message) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            // Remove empty state if present
            const emptyState = messagesContainer.querySelector('.text-center.text-muted');
            if (emptyState) {
                emptyState.remove();
            }

            messagesContainer.insertAdjacentHTML('beforeend', createMessageHTML(message));
            scrollToBottom();
        }

        function showTypingIndicator(userEmail) {
            if (currentUser && userEmail === currentUser.email) return;

            const indicator = document.getElementById('typingIndicator');
            indicator.textContent = `${userEmail} is typing...`;
            indicator.classList.remove('d-none');

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                indicator.classList.add('d-none');
            }, 3000);
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.innerHTML = '<i class="bi bi-circle-fill text-success"></i> Connected';
            } else {
                statusEl.innerHTML = '<i class="bi bi-circle-fill text-danger"></i> Disconnected';
            }
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/login/';
        }

        // Event Listeners
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('messageInput').addEventListener('input', () => {
            sendTypingIndicator();
        });

        // Initialize
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/login/';
        } else {
            loadCurrentUser().then(() => {
                loadRoomDetails();
                loadMessages();
                connectWebSocket();
            });
        }
    </script>
{% endblock %}